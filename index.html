<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Bin - Secure Workspace</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Animations & Styles */
        @keyframes float {
            0% { transform: translateY(0px) rotate(3deg); }
            50% { transform: translateY(-12px) rotate(-1deg); }
            100% { transform: translateY(0px) rotate(3deg); }
        }
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        .glass-header {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        input:focus::placeholder {
            color: transparent;
        }
        .tab-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hidden { display: none !important; }
        
        /* Utility for hiding scrollbar in textareas */
        textarea { -ms-overflow-style: none; scrollbar-width: none; }
        textarea::-webkit-scrollbar { display: none; }

        /* AI Gradient Text */
        .text-gradient-ai {
            background: linear-gradient(to right, #2563eb, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-blue-100 selection:text-blue-900 custom-scrollbar min-h-screen">

    <!-- Firestore Rules Help Modal -->
    <div id="rules-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 border border-slate-200 text-center">
            <div class="flex items-center justify-center gap-3 mb-4 text-amber-600">
                <i data-lucide="lock" class="w-10 h-10"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Access Denied</h2>
            <p class="text-slate-600 mb-6 text-sm leading-relaxed">
                Your Firebase Project's <strong>Firestore Security Rules</strong> are blocking this app. 
                Please ensure your rules allow read/write access to the paths being used.
            </p>
            <button onclick="window.location.reload()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Retry Connection
            </button>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="error-toast" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-4 rounded-xl shadow-2xl z-[100] flex items-center gap-4 max-w-md w-full mx-4 border border-red-400">
        <div class="bg-white/20 p-2 rounded-full shrink-0">
            <i data-lucide="alert-triangle" class="w-6 h-6 text-white"></i>
        </div>
        <div class="flex-1 text-left">
            <h3 class="font-bold text-sm uppercase tracking-wide mb-0.5 leading-none">Notification</h3>
            <p id="error-message" class="text-xs font-medium opacity-90 leading-tight">Something went wrong.</p>
        </div>
        <button onclick="document.getElementById('error-toast').classList.add('hidden')" class="hover:bg-white/20 p-2 rounded-lg transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-slate-50 flex flex-col items-center justify-center gap-4 z-50">
        <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-blue-600"></i>
        <p class="text-slate-500 font-medium">Synchronizing Secure Session...</p>
    </div>

    <!-- Sign In Screen -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-6 bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-blue-100 via-slate-50 to-white">
        <div class="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl shadow-blue-900/10 border border-white p-10 text-center relative overflow-hidden">
            <div class="absolute top-0 right-0 -mr-16 -mt-16 w-48 h-48 bg-blue-600/5 rounded-full blur-3xl"></div>
            <div class="w-24 h-24 bg-blue-600 rounded-[2rem] flex items-center justify-center text-white shadow-xl shadow-blue-200 mx-auto mb-8 animate-float">
                <i data-lucide="upload" class="w-12 h-12" stroke-width="2.5"></i>
            </div>
            <h1 class="text-4xl font-black text-slate-900 mb-3 tracking-tight">Cloud Bin</h1>
            <p class="text-slate-500 mb-10 leading-relaxed font-medium text-sm">Enter your workspace email to identify your contributions and access the repository.</p>
            
            <form id="login-form" class="space-y-4 text-left">
                <div class="relative group">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-2 block">Company Email</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400 group-focus-within:text-blue-600 transition-colors">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                        </div>
                        <input type="email" id="email-input" required placeholder="you@company.com"
                            class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-4 pl-12 pr-4 text-slate-900 font-bold focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder:text-slate-300">
                    </div>
                </div>
                <button type="submit" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-3 transition-all transform hover:scale-[1.02] active:scale-95 shadow-xl shadow-blue-200">
                    Enter Workspace <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </form>
            <div class="mt-8 flex items-center gap-2 justify-center text-[11px] text-slate-400 font-bold uppercase tracking-[0.2em]">
                <i data-lucide="shield-check" class="w-3.5 h-3.5 text-green-500"></i> Firebase Secured Session
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <!-- Header -->
        <header class="glass-header border-b sticky top-0 z-20">
            <div class="max-w-4xl mx-auto px-4 h-20 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-100">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight text-slate-900">Cloud Bin</h1>
                        <span class="text-[9px] font-black text-blue-600 uppercase tracking-widest block leading-none">Workspace Live</span>
                    </div>
                </div>
                <div class="flex items-center gap-3 md:gap-4">
                    <div class="flex flex-col items-end mr-1 text-right">
                        <span class="hidden md:block text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">Signed In As</span>
                        <span id="header-email" class="text-xs md:text-sm font-bold text-slate-700 max-w-[150px] md:max-w-none truncate"></span>
                    </div>
                    <button id="logout-btn" class="w-10 h-10 flex items-center justify-center bg-slate-100 hover:bg-red-50 text-slate-500 hover:text-red-500 rounded-xl transition-all shadow-sm shrink-0" title="Log Out">
                        <i data-lucide="log-out" class="w-4.5 h-4.5"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8">
            <!-- Tabs -->
            <div class="flex bg-white p-2 rounded-[1.5rem] shadow-sm border border-slate-200 mb-10 max-w-sm mx-auto">
                <button id="tab-text" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl tab-transition bg-blue-600 text-white shadow-lg font-bold">
                    <i data-lucide="message-square" class="w-4.5 h-4.5"></i> <span>Feed</span>
                </button>
                <button id="tab-files" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl tab-transition text-slate-400 font-semibold hover:bg-slate-50">
                    <i data-lucide="file-up" class="w-4.5 h-4.5"></i> <span>Uploads</span>
                </button>
            </div>

            <!-- Text Feed Section -->
            <div id="section-text" class="space-y-6">
                <!-- AI Summary -->
                <div id="summary-container" class="hidden bg-gradient-to-br from-indigo-50 to-blue-50 p-6 rounded-[2rem] border border-blue-100 relative">
                    <div class="flex items-start gap-4">
                         <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 shadow-sm shrink-0">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide mb-1 leading-none">AI Insight Summary</h3>
                            <p id="summary-text" class="text-slate-600 text-sm leading-relaxed"></p>
                        </div>
                    </div>
                    <button id="close-summary-btn" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Post Form -->
                <form id="msg-form" class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 relative group">
                    <textarea id="msg-input" placeholder="Share an update..."
                        class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-5 focus:bg-white focus:border-blue-500/20 outline-none resize-none h-32 text-slate-700 font-medium text-lg transition-all"></textarea>
                    <div class="mt-4 flex justify-between items-center">
                        <button type="button" id="magic-polish-btn" class="text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-xl transition-all flex items-center gap-2 text-sm font-bold group/ai" title="Enhance with Gemini">
                            <i data-lucide="sparkles" class="w-4 h-4"></i> 
                            <span class="group-hover/ai:text-gradient-ai">Magic Polish</span>
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-2xl font-black flex items-center gap-2 shadow-lg shadow-blue-100 transform active:scale-95 transition-all">
                            Post <i data-lucide="send" class="w-4.5 h-4.5"></i>
                        </button>
                    </div>
                </form>

                <div class="flex justify-between items-center px-2">
                     <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Live Stream</h3>
                     <button id="summarize-btn" class="text-[10px] font-bold bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 px-3 py-1.5 rounded-lg flex items-center gap-1.5 transition-all shadow-sm">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> Summarize Recent
                     </button>
                </div>

                <div id="messages-list" class="space-y-4"></div>
            </div>

            <!-- Uploads Section -->
            <div id="section-files" class="hidden space-y-8">
                <!-- Drag and Drop Zone -->
                <div id="dropzone" class="bg-white p-10 rounded-[2.5rem] shadow-sm border-2 border-dashed border-slate-200 transition-all">
                    <div id="dropzone-empty" class="text-center cursor-pointer">
                        <div class="w-20 h-20 bg-blue-50 rounded-3xl flex items-center justify-center text-blue-600 mx-auto mb-6 border border-blue-100 transition-transform hover:scale-110">
                            <i data-lucide="upload" class="w-10 h-10"></i>
                        </div>
                        <h3 class="text-2xl font-black text-slate-900 mb-2">Select from Device</h3>
                        <p class="text-slate-400 font-bold uppercase tracking-widest text-[11px]">Drag and drop your files or click to browse</p>
                        <input type="file" id="file-input" class="hidden">
                    </div>

                    <div id="dropzone-selected" class="hidden bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center gap-5">
                                <div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center text-blue-600 shadow-md">
                                    <i data-lucide="file-text" class="w-8 h-8"></i>
                                </div>
                                <div>
                                    <h4 id="selected-file-name" class="font-black text-slate-900 text-lg">filename.ext</h4>
                                    <p id="selected-file-size" class="text-sm font-bold text-slate-400">0 KB</p>
                                </div>
                            </div>
                            <button id="clear-file-btn" class="p-3 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-xl transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <button id="upload-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-3 transition-all shadow-xl shadow-blue-200 active:scale-95">
                             <i data-lucide="upload" class="w-5 h-5"></i> Push to Workspace Cloud
                        </button>
                    </div>
                </div>

                <div class="grid gap-4">
                    <div class="flex items-center justify-between px-4">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em]">Cloud Assets</h3>
                    </div>
                    <div id="files-list" class="space-y-3"></div>
                </div>
            </div>
        </main>
        
        <footer class="py-20 text-center opacity-30">
            <p class="font-black uppercase tracking-[0.6em] text-[10px] text-slate-400 mb-2">Cloud Bin Workspace</p>
            <div class="flex items-center justify-center gap-2 text-[10px] font-bold text-slate-400 uppercase">
                <i data-lucide="shield-check" class="w-3 h-3 text-green-500"></i> Secure Connection Established
            </div>
        </footer>
    </div>

    <!-- Application Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Project: jalal-clound-bin)
        const firebaseConfig = {
            apiKey: "AIzaSyAkSoYQEmr-fX9d2bNH_gguivN9muvTztA",
            authDomain: "jalal-clound-bin.firebaseapp.com",
            projectId: "jalal-clound-bin",
            storageBucket: "jalal-clound-bin.firebasestorage.app",
            messagingSenderId: "480109911420",
            appId: "1:480109911420:web:436342bd75b12edd4398f9",
            measurementId: "G-0QBGTP820G"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "jalal-clound-bin";

        // Global App State
        let currentUser = null;
        let sessionEmail = '';
        let currentMessagesData = [];
        let selectedFile = null;

        // DOM Binding
        const screens = {
            loading: document.getElementById('loading-screen'),
            auth: document.getElementById('auth-screen'),
            app: document.getElementById('app-screen'),
            rules: document.getElementById('rules-modal')
        };
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email-input');
        const headerEmail = document.getElementById('header-email');
        const logoutBtn = document.getElementById('logout-btn');
        const errorToast = document.getElementById('error-toast');
        const errorMessage = document.getElementById('error-message');

        lucide.createIcons();

        function showError(msg) {
            errorMessage.textContent = msg;
            errorToast.classList.remove('hidden');
            screens.loading.classList.add('hidden');
        }

        // Authentication & Session Persistence
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                try {
                    // Fetch persisted session from user settings
                    const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                    const profileDoc = await getDoc(profileRef);
                    
                    if (profileDoc.exists()) {
                        sessionEmail = profileDoc.data().email;
                        headerEmail.textContent = sessionEmail;
                        showApp();
                    } else {
                        showAuthScreen();
                    }
                } catch (err) {
                    console.error("Session Error:", err);
                    if (err.code === 'permission-denied') {
                        screens.rules.classList.remove('hidden');
                        screens.loading.classList.add('hidden');
                    } else {
                        showAuthScreen();
                    }
                }
            } else {
                signInAnonymously(auth).catch(err => {
                    console.error("Auth Failure:", err);
                    showError("Firebase Connection Failed. Enable Anonymous Auth.");
                });
            }
        });

        function showAuthScreen() {
            screens.loading.classList.add('hidden');
            screens.app.classList.add('hidden');
            screens.auth.classList.remove('hidden');
        }

        function showApp() {
            screens.loading.classList.add('hidden');
            screens.auth.classList.add('hidden');
            screens.app.classList.remove('hidden');
            setupDataStreams();
        }

        // Login Logic
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            if (!email || !email.includes('@')) return;

            screens.loading.classList.remove('hidden');
            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'profile');
                await setDoc(profileRef, { email, lastLogin: serverTimestamp() });
                sessionEmail = email;
                headerEmail.textContent = sessionEmail;
                showApp();
            } catch (err) {
                console.error("Login Error:", err);
                showError("Permission Denied: Ensure Firestore rules are set.");
            }
        });

        // Logout Logic
        logoutBtn.addEventListener('click', async () => {
            screens.loading.classList.remove('hidden');
            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'profile');
                await deleteDoc(profileRef);
                window.location.reload();
            } catch (err) {
                showError("Logout Error: " + err.message);
            }
        });

        // UI Tabs Switch
        const tabs = {
            text: { btn: document.getElementById('tab-text'), section: document.getElementById('section-text') },
            files: { btn: document.getElementById('tab-files'), section: document.getElementById('section-files') }
        };

        function setTab(key) {
            Object.keys(tabs).forEach(t => {
                const isActive = t === key;
                tabs[t].section.classList.toggle('hidden', !isActive);
                tabs[t].btn.classList.toggle('bg-blue-600', isActive);
                tabs[t].btn.classList.toggle('text-white', isActive);
                tabs[t].btn.classList.toggle('shadow-lg', isActive);
                tabs[t].btn.classList.toggle('font-bold', isActive);
                tabs[t].btn.classList.toggle('text-slate-400', !isActive);
                tabs[t].btn.classList.toggle('font-semibold', !isActive);
            });
        }
        tabs.text.btn.addEventListener('click', () => setTab('text'));
        tabs.files.btn.addEventListener('click', () => setTab('files'));

        // Gemini AI Functions
        const magicPolishBtn = document.getElementById('magic-polish-btn');
        const summarizeBtn = document.getElementById('summarize-btn');
        const summaryBox = document.getElementById('summary-container');
        const summaryText = document.getElementById('summary-text');

        async function callGemini(prompt) {
            const apiKey = ""; // Runtime Injection
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (err) {
                console.error("AI Error:", err);
                return null;
            }
        }

        magicPolishBtn.addEventListener('click', async () => {
            const msgInput = document.getElementById('msg-input');
            const txt = msgInput.value.trim();
            if (!txt) return;

            magicPolishBtn.disabled = true;
            magicPolishBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Refining...`;
            lucide.createIcons();

            const prompt = `Rewrite this workplace update to be professional, engaging, and clear: "${txt}". Only return the rewritten text.`;
            const result = await callGemini(prompt);
            if (result) msgInput.value = result.trim();

            magicPolishBtn.disabled = false;
            magicPolishBtn.innerHTML = `<i data-lucide="sparkles" class="w-4 h-4"></i> Magic Polish`;
            lucide.createIcons();
        });

        summarizeBtn.addEventListener('click', async () => {
            if (currentMessagesData.length === 0) return;
            summarizeBtn.disabled = true;
            
            const chatLog = currentMessagesData.slice(0, 10).map(m => `${m.userName}: ${m.text}`).join('\n');
            const prompt = `Summarize the key points of this team chat in 2 sentences:\n${chatLog}`;
            const summary = await callGemini(prompt);
            
            if (summary) {
                summaryText.textContent = summary;
                summaryBox.classList.remove('hidden');
            }
            summarizeBtn.disabled = false;
        });

        document.getElementById('close-summary-btn').addEventListener('click', () => summaryBox.classList.add('hidden'));

        // Feed Logic
        const msgForm = document.getElementById('msg-form');
        msgForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text,
                    userName: sessionEmail,
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                input.value = '';
            } catch (err) { showError("DB Error: " + err.message); }
        });

        // File Logic
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const dropEmpty = document.getElementById('dropzone-empty');
        const dropSelected = document.getElementById('dropzone-selected');

        dropEmpty.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFileSelect(e.target.files[0]); });

        dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('border-blue-500', 'bg-blue-50/30'); });
        dropzone.addEventListener('dragleave', () => { dropzone.classList.remove('border-blue-500', 'bg-blue-50/30'); });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-blue-500', 'bg-blue-50/30');
            if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
        });

        function handleFileSelect(file) {
            selectedFile = file;
            document.getElementById('selected-file-name').textContent = file.name;
            document.getElementById('selected-file-size').textContent = (file.size / 1024).toFixed(1) + ' KB';
            dropEmpty.classList.add('hidden');
            dropSelected.classList.remove('hidden');
        }

        document.getElementById('clear-file-btn').addEventListener('click', () => {
            selectedFile = null;
            dropSelected.classList.add('hidden');
            dropEmpty.classList.remove('hidden');
        });

        document.getElementById('upload-btn').addEventListener('click', async () => {
            if (!selectedFile) return;
            const btn = document.getElementById('upload-btn');
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Processing...`;
            lucide.createIcons();

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'files'), {
                    name: selectedFile.name,
                    size: (selectedFile.size / 1024).toFixed(1) + ' KB',
                    type: selectedFile.type,
                    userName: sessionEmail,
                    userId: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                document.getElementById('clear-file-btn').click();
            } catch (err) { showError("Upload Entry Failed: " + err.message); }
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="upload" class="w-5 h-5"></i> Push to Workspace Cloud`;
            lucide.createIcons();
        });

        // Realtime Data Streams
        function setupDataStreams() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (snap) => {
                const msgs = snap.docs.map(d => ({id: d.id, ...d.data()}))
                    .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                currentMessagesData = msgs;
                
                document.getElementById('messages-list').innerHTML = msgs.map(m => `
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 group relative hover:shadow-xl hover:shadow-blue-900/5 transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full uppercase tracking-widest">${m.userName}</span>
                            </div>
                            ${m.userId === currentUser.uid ? `<button onclick="window.delDoc('messages', '${m.id}')" class="text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                        <p class="text-slate-700 leading-relaxed font-semibold text-lg">${m.text}</p>
                    </div>
                `).join('');
                lucide.createIcons();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'files'), (snap) => {
                const fls = snap.docs.map(d => ({id: d.id, ...d.data()}))
                    .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                document.getElementById('files-list').innerHTML = fls.map(f => `
                    <div class="bg-white p-5 rounded-[1.5rem] border border-slate-200 flex items-center justify-between group hover:border-blue-300 transition-all">
                        <div class="flex items-center gap-5">
                            <div class="w-14 h-14 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-300 group-hover:bg-blue-50 group-hover:text-blue-600 transition-all border border-slate-100"><i data-lucide="file-text" class="w-7 h-7"></i></div>
                            <div>
                                <h4 class="font-black text-slate-900 text-lg leading-tight">${f.name}</h4>
                                <div class="flex items-center gap-3 mt-1 text-[10px] font-black uppercase tracking-widest text-slate-400">
                                    <span class="text-blue-600">By ${f.userName.split('@')[0]}</span>
                                    <span>&bull;</span>
                                    <span>${f.size}</span>
                                </div>
                            </div>
                        </div>
                        ${f.userId === currentUser.uid ? `<button onclick="window.delDoc('files', '${f.id}')" class="p-2 text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : ''}
                    </div>
                `).join('');
                lucide.createIcons();
            });
        }

        window.delDoc = (col, id) => {
            if (confirm("Delete this entry?")) {
                deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
            }
        };

    </script>
</body>
</html>